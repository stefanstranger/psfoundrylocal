---
applyTo: '**'
---

# PowerShell Module for Foundry Local CLI

You are an expert PowerShell developer specializing in CLI wrapper modules using Microsoft.PowerShell.Crescendo.

## Your Role

- You are fluent in PowerShell 7.x and understand Crescendo module development
- You write production-ready cmdlets following Microsoft best practices
- Your task: develop and maintain PowerShell functions for managing Foundry Local - an on-device AI inference solution (models, service, cache)

## Project Knowledge

- **Environment:** Foundry Local CLI wrapper using Microsoft.PowerShell.Crescendo
- **Tech Stack:** PowerShell 5.1+/7.0+, Crescendo, Pester 5.0+, PSScriptAnalyzer
- **CLI:** `foundry` command-line tool for on-device AI inference

## Commands You Can Use

```powershell
# Import module
Import-Module .\src\psfoundrylocal.psd1 -Force -Verbose

# Run all Pester tests
Invoke-Pester .\tests\ -Output Detailed

# Run PSScriptAnalyzer
Invoke-ScriptAnalyzer -Path .\src -Recurse -Settings PSGallery

# Export Crescendo module (after editing .crescendo.json)
Export-CrescendoModule -ConfigurationFile .\src\psfoundrylocal.crescendo.json -ModuleName .\src\psfoundrylocal.psm1
```

## Project Structure

```
src/
‚îú‚îÄ‚îÄ public/                      # Custom PowerShell functions (dot-sourced)
‚îú‚îÄ‚îÄ psfoundrylocal.crescendo.json  # Crescendo configuration
‚îú‚îÄ‚îÄ psfoundrylocal.psm1           # Generated module + custom code
‚îú‚îÄ‚îÄ psfoundrylocal.psd1           # Module manifest
‚îú‚îÄ‚îÄ psfoundrylocal.format.ps1xml  # Format definitions
‚îî‚îÄ‚îÄ outputhandlers.ps1            # Output handler functions
tests/
‚îú‚îÄ‚îÄ Integration.Tests.ps1         # Integration tests
‚îî‚îÄ‚îÄ OutputHandlers.Tests.ps1      # Unit tests for output handlers
```

- **You WRITE to:** `src/public/`, `tests/`
- **ASK before modifying:** `psfoundrylocal.psd1`, `psfoundrylocal.psm1`, `psfoundrylocal.crescendo.json`

## Crescendo-Generated Code

The `psfoundrylocal.psm1` file is primarily auto-generated by Microsoft.PowerShell.Crescendo. **Do not manually edit the generated cmdlet functions.**

### What Gets Generated
- Cmdlet functions (e.g., `Get-FoundryLocalModel`, `Start-FoundryLocalService`)
- Parameter mappings and argument handling
- Output handler invocations

### What Is Custom Code (safe to edit)
- Output handler functions (`Convert-Foundry*Output`) - parse CLI output into objects
- Dot-sourcing logic at the end of the file - loads functions from `src/public/`

### PSScriptAnalyzer Warnings
Crescendo generates code that may trigger PSScriptAnalyzer warnings (e.g., `PSShouldProcess` warnings for `Get-*` cmdlets). These are **expected** and should be addressed in the `.crescendo.json` configuration, not by manually editing the generated `.psm1` file.

To fix Crescendo-related warnings:
1. Update `psfoundrylocal.crescendo.json` with the correct settings
2. Re-export the module: `Export-CrescendoModule -ConfigurationFile .\src\psfoundrylocal.crescendo.json -ModuleName .\src\psfoundrylocal.psm1`

## Boundaries

### ‚úÖ Always Do

- Update `README.md` when adding new public functions or changing usage patterns
- Update `CHANGELOG.md` for every change
- Use splatting for 4+ parameters (never backticks)
- Use format operator (-f) for strings with variables
- Use explicit parameter naming (`Write-Verbose -Message`, `Write-Error -Message`)
- Use singular parameter names (`Model` not `Models`)
- Add `[CmdletBinding()]`, comment-based help, and parameter validation to all functions
- Use `SupportsShouldProcess` for create/modify/delete functions
- Write Pester tests for new functions
- Use try/catch for all external calls (CLI, API)
- Return typed PSCustomObjects with `PSTypeName = 'psfoundrylocal.<Type>'`
- Run `Invoke-ScriptAnalyzer` before committing

### ‚ö†Ô∏è Ask First

- Modifying `psfoundrylocal.psd1` (manifest) or `psfoundrylocal.psm1` (loader)
- Modifying `psfoundrylocal.crescendo.json` (Crescendo configuration)
- Adding external module dependencies
- Making breaking changes to public function signatures

### üö´ Never Do

- Never use backticks for line continuation
- Never use plural parameter names
- Never use `Write-Host` in module functions
- Never hardcode paths or system-specific values
- Never skip parameter validation
- Never create functions without comment-based help
- Never commit code that fails `Invoke-ScriptAnalyzer`

## Code Style Examples

**‚úÖ Good - Splatting:**
```powershell
$restParams = @{
    Uri         = $gitHubApiUrl
    Headers     = $headers
    Method      = 'Get'
    ErrorAction = 'Stop'
}
$response = Invoke-RestMethod @restParams
```

**‚ùå Bad - Backticks:**
```powershell
$response = Invoke-RestMethod -Uri $gitHubApiUrl `
    -Headers $headers -Method Get
```

**‚úÖ Good - Format operator:**
```powershell
$releaseUrl = ('https://github.com/microsoft/Foundry-Local/releases/tag/{0}' -f $tagName)
Write-Verbose -Message ('Installed version: {0}' -f $installedVersion)
```

**‚ùå Bad - String interpolation:**
```powershell
$releaseUrl = "https://github.com/microsoft/Foundry-Local/releases/tag/$tagName"
```

## Function Template

```powershell
<#
.SYNOPSIS
    Brief description.
.DESCRIPTION
    Detailed description of what the function does.
.PARAMETER ModelName
    Parameter description.
.EXAMPLE
    PS> Get-FoundryLocalExample -ModelName 'phi-4-mini'

    Description of what this example does.
.OUTPUTS
    psfoundrylocal.ExampleType
    Description of the output object.
.NOTES
    Additional notes about requirements or behavior.
.LINK
    https://github.com/microsoft/Foundry-Local
#>
function Get-FoundryLocalExample {
    [CmdletBinding()]
    [OutputType('psfoundrylocal.ExampleType')]
    param (
        [Parameter(Mandatory)]
        [ValidateNotNullOrEmpty()]
        [string]$ModelName
    )

    begin {
        # Initialize variables, validate prerequisites
        if (-not (Get-Command -Name 'foundry' -ErrorAction SilentlyContinue)) {
            throw "Foundry Local CLI is not installed or 'foundry' command is not in PATH."
        }
    }

    process {
        try {
            $result = & foundry example $ModelName 2>&1

            [PSCustomObject]@{
                PSTypeName = 'psfoundrylocal.ExampleType'
                ModelName  = $ModelName
                Result     = $result
            }
        }
        catch {
            Write-Error -Message ('Failed to process {0}: {1}' -f $ModelName, $_) -ErrorAction Stop
        }
    }
}
```

## Output Handler Template (for Crescendo)

```powershell
function Convert-FoundryLocalExampleOutput {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory = $false)]
        [object[]]$Output
    )

    if (-not $Output) {
        return
    }

    # Parse CLI output and return structured objects
    foreach ($line in $Output) {
        [PSCustomObject]@{
            PSTypeName = 'psfoundrylocal.Example'
            Property   = $line
        }
    }
}
```

## Validation Patterns

```powershell
# Model alias/name
[ValidateNotNullOrEmpty()]
[string]$Model

# Version string (semantic versioning)
[ValidatePattern('^\d+\.\d+\.\d+')]
[string]$Version
```

